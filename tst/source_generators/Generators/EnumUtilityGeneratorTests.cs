// <copyright file="EnumUtilityGeneratorTests.cs" company="VoxelGame">
//     MIT License
//     For full license see the repository.
// </copyright>
// <author>jeanpmathes</author>

using System;
using System.Linq;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using VoxelGame.SourceGenerators.Generators;
using Xunit;

namespace VoxelGame.SourceGenerators.Tests.Generators;

public class EnumUtilityGeneratorTests
{
    private const String VectorClassText = """

                                           namespace TestNamespace;

                                           public enum TestEnum
                                           {
                                               A = 1,
                                               B = 2,
                                               C = 4
                                           }
                                           """;

    private const String ExpectedGeneratedClassText = """
                                                      // <auto-generated />
                                                      // by EnumUtilityGenerator
                                                      
                                                      namespace TestNamespace;
                                                      
                                                      /// <ignore />
                                                      public static partial class EnumExtensions
                                                      {
                                                          /// <summary>
                                                          /// A faster alternative to <see cref="global::System.Object.ToString"/> for the enum <see cref="global::TestNamespace.TestEnum"/>.
                                                          /// </summary>
                                                          public static global::System.String ToStringFast(this global::TestNamespace.TestEnum value) 
                                                              => value switch
                                                              {
                                                                  global::TestNamespace.TestEnum.A => nameof(global::TestNamespace.TestEnum.A),
                                                                  global::TestNamespace.TestEnum.B => nameof(global::TestNamespace.TestEnum.B),
                                                                  global::TestNamespace.TestEnum.C => nameof(global::TestNamespace.TestEnum.C),
                                                      
                                                                  _ => value.ToString()
                                                              };
                                                      }
                                                      """;

    [Fact]
    public void EnumUtilityGenerator_ShouldGenerateExtensionMethodForEnum()
    {
        EnumUtilityGenerator generator = new();
        var driver = CSharpGeneratorDriver.Create(generator);
        
        var compilation = CSharpCompilation.Create(nameof(EnumUtilityGeneratorTests),
            [CSharpSyntaxTree.ParseText(VectorClassText)],
            [MetadataReference.CreateFromFile(typeof(Object).Assembly.Location)]);
        
        GeneratorDriverRunResult runResult = driver.RunGenerators(compilation).GetRunResult();
        SyntaxTree generatedFileSyntax = runResult.GeneratedTrees.Single(t => t.FilePath.EndsWith("TestEnum.g.cs"));
        
        Assert.Equal(ExpectedGeneratedClassText,
            generatedFileSyntax.GetText().ToString(),
            ignoreLineEndingDifferences: true);
    }
}
